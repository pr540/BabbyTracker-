{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <!-- Online/Offline Sync Indicator -->
    <div id="syncStatus" class="sync-indicator">
        <i class="fa-solid fa-cloud-check"></i> <span>Connected</span>
    </div>

    <!-- Status Card -->
    <div class="status-card {% if ongoing_sleep %}sleeping{% else %}awake{% endif %}">
        <div class="status-icon">
            {% if ongoing_sleep %}
            <i class="fa-solid fa-moon"></i>
            {% else %}
            <i class="fa-solid fa-sun"></i>
            {% endif %}
        </div>
        <div class="status-text">
            <h2>{% if ongoing_sleep %}Sleeping{% else %}Awake{% endif %}</h2>
            <p>{% if ongoing_sleep %}Started at {{ ongoing_sleep.start_time.strftime('%H:%M') }}{% else %}Ready for
                nap?{% endif %}</p>
        </div>
    </div>

    <!-- Night Summary Card -->
    <div class="night-summary-card">
        <div class="summary-header">
            <i class="fa-solid fa-moon"></i>
            <h3>Last Night Summary</h3>
        </div>
        <div class="summary-stats">
            <div class="s-item">
                <span class="s-val">{{ night_cries | default(0) }}</span>
                <span class="s-lab">Cries</span>
            </div>
            <div class="s-item">
                <span class="s-val">{{ night_wakeups | default(0) }}</span>
                <span class="s-lab">Wakeups</span>
            </div>
            <div class="s-item">
                <span class="s-val">{{ night_sleep_hours | default(0) }}h</span>
                <span class="s-lab">Sleep</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Sleeps</h3>
            <span class="count">{{ sleep_count_today | default(0) }}</span>
            <span class="label">{{ sleep_duration_today | default('0h 0m') }}</span>
        </div>
        <div class="stat-card">
            <h3>Cries</h3>
            <span class="count">{{ cry_count_today | default(0) }}</span>
            <span class="label">Today</span>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-container">
        <form action="/sleep/toggle" method="post">
            <button type="submit"
                class="action-btn big-btn {% if ongoing_sleep %}wake-btn{% else %}sleep-btn{% endif %}">
                {% if ongoing_sleep %}
                <i class="fa-solid fa-bell-slash"></i>
                <span>Wake Up</span>
                {% else %}
                <i class="fa-solid fa-bed"></i>
                <span>Sleep</span>
                {% endif %}
            </button>
        </form>

        <form action="/cry" method="post">
            <input type="hidden" name="intensity" value="Normal">
            <button type="submit" class="action-btn big-btn cry-btn">
                <i class="fa-solid fa-face-sad-tear"></i>
                <span>Log Cry</span>
            </button>
        </form>
    </div>

    <!-- Voice Tracker -->
    <div style="margin-bottom: 24px;">
        <button id="voiceBtn" class="voice-recorder-btn">
            <i class="fa-solid fa-microphone"></i> Voice Tracker
        </button>
    </div>

    <!-- Daily Routine -->
    <div class="tasks-container">
        <div class="section-header">
            <h3>Daily Routine</h3>
            <div class="progress-container">
                {% set completed = tasks|selectattr('is_completed')|list|length %}
                {% set total = tasks|length %}
                {% set percent = (completed / total * 100)|int if total > 0 else 0 %}
                <span class="progress-text">{{ completed }}/{{ total }}</span>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:{{ percent|default(0) }}%;"></div>
                </div>
            </div>
        </div>
        <div class="tasks-grid">
            {% for task in tasks %}
            <div class="task-row">
                <form action="/task/toggle/{{ task.id }}" method="post" class="task-form">
                    <button type="submit" class="task-card {% if task.is_completed %}completed{% endif %}">
                        <div class="task-status">
                            <i
                                class="fa-solid {% if task.is_completed %}fa-circle-check{% else %}fa-circle{% endif %}"></i>
                        </div>
                        <div class="task-info">
                            <span class="task-title">{{ task.title }}</span>
                            <span class="task-time">{{ task.due_time }}</span>
                        </div>
                    </button>
                </form>
                {% if not task.is_completed %}
                <form action="#" method="post"
                    onsubmit="event.preventDefault(); showToast('Task skipped', 'fa-circle-xmark');">
                    <button type="submit" class="skip-btn">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent History -->
    <div class="recent-list">
        <div class="section-header">
            <h3>Recent Activity</h3>
            <a href="/analysis" class="view-all">View All</a>
        </div>
        {% for cry in recent_cries %}
        <div class="list-item">
            <div class="item-icon cry-icon">
                <i class="fa-solid {% if 'Voice' in cry.intensity %}fa-microphone{% else %}fa-droplet{% endif %}"></i>
            </div>
            <div class="item-details">
                <span class="item-title">
                    {{ cry.intensity }}
                    <span class="verified-badge"><i class="fa-solid fa-check"></i> Recorded</span>
                </span>
                <span class="item-time">{{ cry.timestamp.strftime('%H:%M') }}</span>
            </div>
            {% if cry.audio_url %}
            <div class="audio-player">
                <audio id="audio-{{cry.id}}" src="{{cry.audio_url}}"></audio>
                <button onclick="document.getElementById('audio-{{cry.id}}').play()" class="play-btn">
                    <i class="fa-solid fa-play"></i>
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}